# 3. 애그리거트

## 3.1 애그리거트
- 애그리거트란 관련된 객체의 `묶음`
- 디테일한 각각의 도메인을 파악하기엔 어려움이 있음
- 관련된 모델을 하나로 묶은 것이 애그리거트

![image](https://github.com/devmizz/24th-Study-DDD/assets/92210823/c5fcd297-0cad-447c-ae6c-fcfe862da9f6)

- 각 애그리거트는 자신만을 관리
  - 주문을 하다가 회원정보를 바꾸지 않는다.
  - 회원 애그리거트에 요청을 한다.
- 애그리거트는 같은 라이프 사이클을 가질 가능성이 높음
  - 상품과 리뷰는 같은 애그리거트에 포함되지 않음
  - 전혀 별개의 애그리거트, 그저 관련성이 높아 보일 뿐
 
## 3,2 애그리거트 루트
- 각 도메인을 애그리거트로 묶는다 하더라도 파악이 어려움
- 또한, 데이터의 일관성(정합성)을 유지하기 위해선 이를 통합적으로 관리할 무언가가 필요함 = 애그리거트 루트
- 중복 회피와 도메인의 일관성 관점에서 애그리거트 루트는 중요함
- 루트에서 관리하기 위해선 개별 접근이 차단되어야 함 -> 무의미한 setter가 있어서는 안 됨

- 하나의 트랜잭션에서는 하나의 애그리거트만 수정하도록 노력
  - 트랜잭션 충돌 방지가 목적
- 비동기 처리나 이벤트를 통해 하나의 트랜잭션에 하나의 에그리거트만 처리하도록 노력

## 3.3 리포지터리와 애그리거트
- 리포지터리와 애그리거트는 1:1 관계
- 애그리거트 루트를 위한 리포지터리만 있으면 됨
- 단일한 리포지터리는 애그리거트 루트에 대해 완벽한 기능을 제공해야 함

## 3.4 ID를 이용한 애그리거트 참조
- JPA를 이용하면 객체간 연관관계를 맺어, 연결된 객체를 쉽게 로딩할 수 있음
- 만약, 애그리거트 간에 연관관계가 맺어져 있다면?
  - 다른 애그리거트의 값을 변경할 수 있음

![image](https://github.com/devmizz/24th-Study-DDD/assets/92210823/fe03f03e-97c9-4f9b-8dc3-8eaa2842786e)

- 연관관계가 아닌, ID를 통해 애그리거트간 관계를 맺으면 세 가지 문제를 해결할 수 있음
  - 객체로써 함께 조회되는 것이 아니기 때문에, 다른 애그리거트의 값을 변경할 일이 없음 (N+1 문제 주의 필요)
  - Eager, Lazy에 대한 고민이 줄어들음 -> 어차피 ID를 통해서 다시 조회해야 되기 때문
  - 확장이 용이해짐. 추후 MSA로 분리를 시작하게 될 때, 연관관계를 분리하는 것에 대한 걱정을 하지 않아도 됨
 
## 3.5 애그리거트 간 집합 연관
- 1:N과 N:M
- 카테고리 (상품들) vs 상품 (카테고리)
- 닥후를 고르는 게 맞음 -> 카테고리를 조회하면서 상품들을 조회하면 성능상 문제 발생 (카테고리 내 상품이 1억개라면?)
  - 만약 카테고리 내 상품을 찾아야 한다면, 적절히 쿼리를 구성해서 조회할 수 있음
- 만약 상품이 여러개의 카테고리를 가질 수 있다면 -> N:M
  - 중간 테이블을 놓는 방법으로 위와 같이 해결할 수 있음
 
![image](https://github.com/devmizz/24th-Study-DDD/assets/92210823/7635f281-d521-479d-9d86-c6e7dd4eefaa)


## 3.6 애그리거트를 팩토리로 사용하기
- 애그리거트가 하나의 팩토리가 될 수 있음
- 서비스에서 조건애 따라 다른 모델의 생성에 영향을 줄 수 있다면?
  - 상점의 상태에 따라 상품의 생성 여부가 결정
  - 서비스 로직 -> 상점의 상태 검사 & 상품의 생성 ❌
  - 서비스 로직 -> 상점에서 상품의 생성 ✅
    - 상점에서 상품을 생성할 때, 자신의 상태를 검사
  ```java
  public class Store extends Member {
    public Product createProduct(ProductId newProductId, /*...*/) {
        if (isBlocked()) throw new StoreBlockedException();
        return new Product(newProductId, getId(), /*...*/);
    }
  }
  ```
