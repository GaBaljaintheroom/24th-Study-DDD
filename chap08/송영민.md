# DDD 8장 - 애그리거트와 트랜잭션
부제: JPA Lock

### 8-1. 애그리거트와 트랜잭션
서로다른 트랜잭션이 같은 테이블을 동시에 접근할때 일관성의 문제가 발생할 수 있다.
이를 막기 위해서는 동시에 여러 트랜잭션이 같은 데이터를 조작하지 않도록 막아야 한다.

### 8-2. 선점 잠금(Pessimistic Lock, 비관적 락)
- 흔히 SQL에서 SELECT ~ FOR UPDATE, SELECT ~ FOR SHARE 에 쓰는 친구들이다.
- JPA의 `LockMode.PESSIMISTIC_WRITE` 에 해당한다.
- `SELECT ~ FOR UPDATE` 에 걸린 ROW를 LOCK하여 타 트랜잭션의 접근 자체를 막는(Block)다.
- 교착 상태(Deadlock)의 발생 가능성이 존재한다. A->B 순으로 건드리는 트랜잭션과, B->A  순으로 건드리는 트랜잭션이 동시에 수행된다고 가정하면 교착 상태가 발생한다.
- 이는 JPA의 `잠금 최대 대기 시간`을 설정하여, 설정한 시간만큼 기다려도 잠금을 획득하지 못하면 Exception을 발생시킨다.
- 면접에서 `JPA에서 교착 상태는 어떻게 해결할까요?` 라는 질문을 받으면, 위 내용을 바탕으로 이렇게 답할 수 있다.
    - JPA의 잠금 최대 대기시간을 줄여 데드락 발생시 트랜잭션을 재시작하게 한다.
    - 무조건 특정 순서로 (교착 상태의 필요조건인 순환 대기를 일으키지 않도록) 트랜잭션을 수행한다.
    - 교착 상태가 발생하지 않는 다른 잠금 기법 (낙관적 락 등)을 사용한다.

### 8-3. 비선점 잠금(Optimistic Lock, 낙관적 락)
- 작동 원리는
    - 간단하게, 테이블의 버전 관리용 필드를 하나 추가한다. (일반적으로 INT같은 숫자형)
    - 트랜잭션들은 SELECT할때 읽었던 버전이 현 버전과 일치하는 ROW만 업데이트하도록 쿼리를 날린다. (i.e. `UPDATE member SET name = '송영민' AND version = 2 WHERE version = 1`)
    - 만약 다른 트랜잭션이 UPDATE를 먼저 쳤다면, version값은 이미 2일테고, 바로 위의 쿼리 WHERE조건문을 만족하지 않으므로, 위 UPDATE문의 결과 행은 0줄이 된다.
    - 결과 행이 0줄이라는건 다른 트랜잭션이 해당 ROW를 건드렸다는 뜻이므로, 로킹 예외가 발생한 것이다.
- 당연히, 위의 version 비교와 version increase 쿼리가 어플리케이션 단에 적용이 되어있어야 하고, DB 자체는 낙관적 락과 아무런 관련이 없다. (즉 MySQL이 아닌 여타 다른 모든 DB에 적용할 수 있다.)
- 즉 이는 데이터의 일관성을 어플리케이션에서 관리하는 방법이다.
- 물론 킹갓JPA는 이를 마치 MySQL의 기능인것마냥 어노테이션으로 낙관적락을 설정할 수 있도록 기능을 제공한다. `LockMode.OPTIMISTIC_LOCK`
- HTML(뷰)단이 있는 트랜잭션의 경우 (내 정보 수정 페이지 등), hidden 태그로 기존 버전을 폼에 심어두고, 업데이트 버튼을 누를때 위 낙관적 락 플로우를 태우면, 중간에 내 정보가 다른곳에서 변경되었다면 업데이트를 실패한다.
- 경우에 따라 지금 내 테이블이 변경된건 아닌데, 자식 테이블이나 연관 테이블이 변경되어서 추후 내 테이블을 조회하는 경우 다른 버전임을 명시해야할 경우도 있다. 이럴때는 `LockMode.OPTIMISTIC_FORCE_INCREMENT` 를 사용하면, 데이터의 변경 여부와 상관 없이 버전+1 을 한다.

### 8-4 오프라인 선점 잠금
- 여러 트랜잭션을 걸쳐 락을 걸려면 어떻게 할까? 소위 말하는 "따닥" 같은 경우.
- 책에서는 LockManager 인터페이스를 만들어 RDBMS를 통한 해당 록 매니저 구현체를 만들었다.
- 흔히 Redis 분산락도 지금 이 컨텍스트에 사용되는 친구이다.
- Java의 ReentrantLock 역시 (WAS가 싱글 인스턴스라면) 같은 역할을 한다.
- 명시적으로 코드레벨에서 "어디부터 어디까지 임계구역" 임을 설정하고, 다른 그 어떤 친구도 임계구역을 넘볼 수 없게 만들 수 있다.